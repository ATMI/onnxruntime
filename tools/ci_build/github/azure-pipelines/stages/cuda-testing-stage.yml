parameters:
  - name: CudaVersion
    type: string
    default: '11.8'
# these 2 parameters are used for debugging.
  - name: SpecificArtifact
    type: boolean
    default: false
  - name: BuildId
    type: string
    default: '0'
  - name : docker_base_image
    type: string
  - name: linux_trt_version
    type: string
stages:
  variables:
  - name: docker_base_image
    ${{ if eq(parameters.CudaVersion, '11.8') }}:
      value: nvidia/cuda:11.8.0-cudnn8-devel-ubi8
    ${{ if eq(parameters.CudaVersion, '12.2') }}:
      value: nvidia/cuda:12.2.2-cudnn8-devel-ubi8
  - name: linux_trt_version
    ${{ if eq(parameters.CudaVersion, '11.8') }}:
      value: 8.6.1.6-1.cuda11.8
    ${{ if eq(parameters.CudaVersion, '12.2') }}:
      value: 8.6.1.6-1.cuda12.0
  stage:
    - template: ../nuget/templates/test_win.yml
      parameters:
        AgentPool: 'onnxruntime-Win2022-GPU-T4'
        NugetPackageName: 'Microsoft.ML.OnnxRuntime.Gpu'
        ArtifactSuffix: 'GPU'
        StageSuffix: 'GPU'
        Skipx86Tests: 'true'
        CudaVersion: ${{ parameters.CudaVersion }}
    ## Linux GPU Testing
    - template: ../nuget/templates/test_linux.yml
      parameters:
        AgentPool: Onnxruntime-Linux-GPU
        ArtifactSuffix: 'GPU'
        StageSuffix: 'GPU'
        TRT_VERSION: ${{ variables.linux_trt_version }}
        DockerBaseImage: ${{ variables.docker_base_image }}
        CustomOpArtifactName: onnxruntime-linux-x64-gpu
        NugetPackageName: 'Microsoft.ML.OnnxRuntime.Gpu'
        SpecificArtifact: ${{ parameters.specificArtifact }}
        BuildId: ${{ parameters.BuildId }}